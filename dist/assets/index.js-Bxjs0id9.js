let l=[];function s(e){if(l.length>0&&(chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:l}),l=[]),!e||e.length===0){console.log("ðŸŽ¯ No sites to block. Auto restriction disabled.");return}const i=new Set(e);chrome.tabs.query({url:["https://*/*","http://*/*"]},r=>{r.forEach(t=>{try{const c=new URL(t.url).hostname;i.has(c)&&(console.log(`ðŸŽ¯ Redirecting open tab on blocked site: ${c}`,t),chrome.tabs.update(t.id,{url:chrome.runtime.getURL("block.html?from=auto-restriction")}).catch(u=>{console.warn(`Failed to redirect tab ${t.id}:`,u.message)}))}catch{console.debug("Skipping invalid tab URL:",t.url)}})});const o=e.map((r,t)=>{const n=1e3+t;return n>=5e4?(console.error("âŒ Rule ID exceeds limit:",n),null):{id:n,priority:1,action:{type:"redirect",redirect:{url:chrome.runtime.getURL("block.html")}},condition:{urlFilter:`||${r}`,resourceTypes:["main_frame"]}}}).filter(Boolean);chrome.declarativeNetRequest.updateDynamicRules({addRules:o}),l=o.map(r=>r.id),console.log("âœ… Applied blocking rules:",o)}chrome.storage.sync.get(["blockedSites"],e=>{s(e.blockedSites||[])});chrome.storage.onChanged.addListener((e,i)=>{if(i==="sync"&&e.blockedSites){const o=e.blockedSites.newValue||[];s(o)}});chrome.runtime.onInstalled.addListener(e=>{e.reason==="install"&&chrome.runtime.openOptionsPage()});
